<?xml version="1.0" encoding="UTF-8" ?>
<definitions
        xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:activiti="http://activiti.org/bpmn"
        typeLanguage="http://www.w3.org/2001/XMLSchema"
        expressionLanguage="http://www.w3.org/1999/XPath"
        targetNamespace="activiti-report">

    <process id="intermediateReminder" name="Reminder">

        <startEvent id="theStart" name="Start"/>

        <transaction id="reminderTransaction" name="Reminder Transaction">

            <userTask id="cancelReminder" name="User Cancel Timer Task"/>

            <intermediateCatchEvent id="timer" name="Timer">
                <timerEventDefinition>
                    <timeDuration>${duration}</timeDuration>
                </timerEventDefinition>
            </intermediateCatchEvent>

            <serviceTask id="reminderTask" name="Remind Service Task"
                         activiti:expression="#{reminderDelegate.expirationReminder(execution)}"/>

            <startEvent id="reminderStart"/>
            <parallelGateway id="fork" name="Fork"/>
            <sequenceFlow sourceRef="reminderStart" targetRef="fork"/>

            <sequenceFlow sourceRef="fork" targetRef="timer"/>
            <sequenceFlow sourceRef="fork" targetRef="cancelReminder"/>
            <sequenceFlow sourceRef="timer" targetRef="reminderTask"/>

            <exclusiveGateway id="join" name="Join"/>
            <sequenceFlow sourceRef="cancelReminder" targetRef="join"/>
            <sequenceFlow sourceRef="reminderTask" targetRef="join"/>
            <endEvent id="tpEnd">
                <cancelEventDefinition/>
            </endEvent>

            <sequenceFlow sourceRef="join" targetRef="tpEnd"/>

        </transaction>
        <boundaryEvent id="tpCancel" attachedToRef="reminderTransaction">
            <cancelEventDefinition />
        </boundaryEvent>

        <sequenceFlow sourceRef="theStart" targetRef="reminderTransaction"/>
        <sequenceFlow sourceRef="reminderTransaction" targetRef="theEnd"/>
        <endEvent id="theEnd" name="End"/>

        <boundaryEvent id="catchError" attachedToRef="reminderTransaction">
            <errorEventDefinition errorRef="BusinessExceptionOccurred"/>
        </boundaryEvent>

        <sequenceFlow sourceRef="catchError" targetRef="theEnd"/>

    </process>

</definitions>
